# TCP/IP Capsulation & Encapsulation

## 개요

- 본 문서는 클라이언트에서 서버로 데이터가 전송될 때 TCP/IP 계층을 따라 어떻게 캡슐화되어 전달되는지를 설명합니다.
- 애플리케이션 데이터가 메시지 -> 세그먼트 -> 데이터그램 -> 프레임으로 변환되는 흐름을 단계별로 정리합니다.

---

![TCP/IP Cap](/KH_Security/Network/img/LayerPacket.png)

- 상위계층의 Data가 포함된 `Payload`라고 하며 그 옆에 붙은 항목들은 해당 계층에서 추가된 `Header`라고 합니다.

---

## 애플리케이션 계층

- 클라이언트에서는 애플리케이션이 실행 중입니다.
- FileZilla는 Message를 서버로 보내려고 합니다.
- 이 단계에서 데이터는 단순한 Message 형태입니다.
- Message를 TCP 계층으로 전송합니다.

---

## 전송 계층 (TCP)

- 애플리케이션에서 내려온 메시지는 TCP 계층으로 전달됩니다.
- 그림에서는 다음 정보가 포함됩니다.
  - 출발지 포트: 4230 (FileZilla 클라이언트)
  - 목적지 포트: 21 (FTP 서버)
  - 애플리케이션 계층에서 생성된 Message에 목적지 포트, 출발지포트 헤더가 붙습니다
  - TCP는 세그먼트(Segment)를 생성합니다.

- TCP는 신뢰성을 보장하기 위해 순서 제어, 오류 제어를 수행합니다.

---

## 네트워크 계층 (IP)

- TCP 세그먼트는 IP 계층으로 전송합니다.
- 그림 기준으로 다음과 같이 구성됩니다.
  - 출발지 IP: 1.1.1.2 (클라이언트)
  - 목적지 IP: 1.1.1.3 (서버)
  - TCP 계층에서 생성된 Segment에 목적지 IP, 출발지 IP 헤더가 붙습니다
- IP 계층에서는 출발지 IP와 목적지 IP를 추가되어 데이터그램(Datagram)을 생성합니다.

- IP 계층은 목적지까지의 전달만 담당하며, 신뢰성은 보장하지 않습니다.

---

## 데이터 링크 계층 (Ethernet)

- 데이터그램은 Ethernet 계층으로 전송합니다.
- 프레임에는 다음 정보가 포함됩니다.
  - 목적지 MAC 주소
  - 출발지 MAC 주소
  - IP 계층에서 생성된 Datagram에 위와 같은(목적지 MAC주소, 출발지 MAC주소) 'Frame 헤더'가 붙습니다
- Ethernet 계층에서는 MAC 주소를 포함한 프레임(Frame)을 생성합니다.

- 이 단계에서 실제 물리적인 네트워크 전송이 가능해집니다.

---

## 서버 측 수신 과정

- 서버에서는 프레임을 수신한 후 역순으로 처리합니다.
- Ethernet -> IP -> TCP -> 애플리케이션 순서로 디캡슐화가 진행됩니다.
- 최종적으로 FTP 서버(vsftpd)가 21번 포트에서 요청 메시지를 수신합니다.
- 서버는 해당 요청을 처리한 후 응답을 동일한 방식으로 다시 캡슐화하여 전송합니다.

---
