# GROUP BY & HAVING

---

## 그룹 함수 (다중 행 함수)

- 여러 행을 기반으로 계산된 값을 반환하는 함수이다.
- NULL은 자동으로 무시된다.
- GROUP BY 없이 일반 컬럼과 함께 사용할 수 없다.

| 함수 | 기능 |
|------|------|
| MAX(컬럼) | 최대값 |
| MIN(컬럼) | 최소값 |
| AVG(컬럼) | 평균 |
| SUM(컬럼) | 합계 |
| COUNT(컬럼) | NULL 제외 행 수 |
| COUNT(*) | 전체 행 수 |
| STDDEV(컬럼) | 표준편차 |
| VARIANCE(컬럼) | 분산 |

---

## 그룹 함수와 NULL

- NULL은 계산에서 제외된다.
- COUNT(comm)는 NULL 제외

### 예제 - NULL 제외
```sql
  SELECT SUM(comm) AS 총액, TO_CHAR(AVG(comm),'999,999') AS 평균
  FROM emp;
```

### 예제 - NVL을 이용한 NULL 포함
```sql
  SELECT SUM(NVL(comm,0)) AS 총액, COUNT(*) AS 전체사원수, TO_CHAR(AVG(NVL(comm,0)),'999,999') AS 평균
  FROM emp;
```

---

## 그룹 함수와 다중 행 연산자

### 10번 부서원들보다 급여가 높은 사원을 검색 예시

- **MAX**
```sql
  SELECT eno 사번, ename 이름, dno 부서번호
  FROM emp
  WHERE sal > (SELECT MAX(sal)
               FROM emp
               WHERE dno = '10');
```

- **ALL**
```sql
  SELECT eno 사번, ename 이름, dno 부서번호
  FROM emp
  WHERE sal > ALL(SELECT sal
                  FROM emp
                  WHERE dno = '10');
```

---

## GROUP BY

- SELECT 절의 일반 컬럼은 반드시 GROUP BY에 포함
- 포함하지 않으면 에러 발생

### 업무별 평균 급여, 평균 연봉을 검색 예시
```sql
  SELECT job 업무, TO_CHAR(AVG(sal),'999,999') 평균_급여, TO_CHAR(AVG(sal*12+NVL(comm,0)), '999,999') 평균_연봉
  FROM emp
  GROUP BY job;
```

### 부서별 평균 급여, 평균 연봉을 검색 예시
```sql
  SELECT d.dno 부서번호, dname 부서,TO_CHAR(AVG(sal),'999,999') 평균_급여, TO_CHAR(AVG(sal*12+NVL(comm,0)),'999,999') 평균_연봉
  FROM dept d, emp e
  WHERE d.dno = e.dno
  GROUP BY d.dno, dname
  ORDER BY d.dno;
```

---

## 카디널리티 (Cardinality)

- 값의 개수(기수)를 의미합니다.
- SELECT 절의 모든 컬럼은 카디널리티가 같아야 합니다.
- 그룹 함수와 함께 사용하는 일반 컬럼은 반드시 GROUP BY에 포함합니다.

---

## 정렬

- GROUP BY는 정렬을 보장하지 않습니다.
- 정렬이 필요할 경우 반드시 ORDER BY를 사용합니다.

---

## HAVING

- `HAVING` : GROUP BY로 집계된 결과에 조건을 적용하는 절입니다.

### 형식
```sql
  SELECT ...
  FROM 테이블 ...
  WHERE 조건 ...
  GROUP BY 컬럼
  HAVING [그룹조건] ...
  ORDER BY 정렬_대상 ... ;
```

### 부서별 급여 평균이 3천 달러 미만인 부서의 평균 급여를 검색 예시
```sql
  SELECT dno 부서번호, TO_CHAR(AVG(sal),'$999,999') 평균급여
  FROM emp
  GROUP BY dno
  HAVING AVG(sal) < 3000;
```

### 부서별 급여 평균이 3천 달러 미만인 부서의 최대 급여를 검색 예시
```sql
  SELECT dno 부서번호, MAX(sal) 최대급여
  FROM emp
  GROUP BY dno
  HAVING AVG(sal) < 3000;
```

### WHERE + GROUP BY 이용한 검색 예시

- 부서 중 가장 급여를 많이 받는 부서를 검색
```sql
  SELECT d.dno, dname, AVG(sal)
  FROM dept d, emp e
  WHERE d.dno = e.dno
  GROUP BY d.dno, dname
  HAVING AVG(sal) = (SELECT MAX(AVG(sal))
                     FROM emp
                     GROUP BY dno);
```
