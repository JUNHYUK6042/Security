# Subquery

## 개요
- 본 문서는 SQL에서 사용되는 서브 쿼리의 개념과 단일 행 서브 쿼리,  
다중 행 서브 쿼리, 다중 열 서브 쿼리를 학습하기 위한 문서이다.

---

## 서브 쿼리 개념
- SQL 문 안에 완전한 SELECT 문이 포함된 형태이다.
- 외부 SQL 문을 메인 쿼리라 한다.
- 내부 SELECT 문을 서브 쿼리라 한다.
- 서브 쿼리는 응용 프로그램으로 대치 가능하지만 성능과 비용 면에서 우수하다.

### 서브 쿼리 종류

| 종류 | 설명 | 비교 연산자 |
|------|------|-------------|
| 단일행 서브쿼리 | 결과가 1행 1열인 경우입니다 | =, <, >, <=, >=, <> |
| 다중행 서브쿼리 | 결과가 여러 행인 경우입니다 | IN, ANY, ALL |
| 다중열 서브쿼리 | 결과가 여러 열인 경우입니다 | IN |

---

## Single Row Subquery (단일 행 서브쿼리)

```sql
  SELECT 컬럼 ...
  FROM  
  테이블
  WHERE 컬럼 단일_행_연산자 (SELECT 문장 : Sub query문)
  ......;
```

- 단일 행 연산자를 사용하고, 서브 쿼리의 결과는 반드시 한 개의 값만 검색되어야 합니다.
- 서브 쿼리는 반드시 괄호로 묶어야 합니다.
- 서브 쿼리는 메인 쿼리 실행 전에 실행되며, 서브 쿼리 결과는 메인 쿼리에 사용된다.
- 단일 행 연산자는 오른쪽에 기술한다.
  - `=, <, >, <=, >=, !=`
- WHERE절의 컬럼 수와 타입은 SELECT절과 1:1 대응 관계가 되어야 한다.

### 단일 행 서브쿼리 실습
  
- 남궁연호보다 급여를 많이 받는 사원을 검색하는 예시
```sql
  SELECT eno 사번, ename 이름
  FROM emp                               
  WHERE sal > (SELECT sal
               FROM emp
               WHERE ename = '남궁연호');
```
- 남궁연호보다 급여가 높은 사원을 조회합니다.
- 서브쿼리가 여러 행을 반환하면 ORA-01427 오류가 발생합니다.
- 단일 비교 연산자는 반드시 하나의 값만 반환해야 합니다.

---

## Multi Row Subquery (다중행 서브쿼리)

- 서브쿼리 결과가 여러 행일 때 사용하는 방식입니다.

### IN 연산자 
```text
나열된(검색된) 값중에하나만일치하면됩니다.
```

```sql
  SELECT eno 사번, ename 이름
  FROM emp
  WHERE hdate IN (SELECT hiredate
                  FROM professor
                  WHERE section = '화학');
```
- 화학과 교수님의 부임일과 같은 날 입사한 사원의 명단을 검색합니다.

```sql
  SELECT * FROM emp
  WHERE mgr IN (SELECT mgr FROM emp
                WHERE dno = '20')
  AND dno != 20; 
```

- 20번 부서원과 동일한 관리자로 부터 관리 받는 사원의 명단을 검색합니다.
- `dno != 20` : 서브쿼리에서 기준이 된 부서(20번)의 사원이 메인 쿼리 결과에 다시 포함되는 것을 방지합니다.

### ANY 연산자
```sql
  SELECT eno, ename, sal
  FROM emp
  WHERE sal < ANY (SELECT sal
                   FROM emp
                   WHERE dno = 10);
```
- 10번 부서 사원의 급여 중 하나라도 큰 값이 존재하면 조건을 만족합니다.

### ALL 연산자
```sql
  SELECT eno, ename, sal
  FROM emp
  WHERE sal < ALL (SELECT sal
                   FROM emp
                   WHERE dno = 10);
```
- 10번 부서 사원의 최저 급여보다 작은 급여를 가진 사원을 조회합니다.

### ANY, ALL 설명

```text
컬럼 > ALL  →  컬럼 > MAX()  : 가장 큰 값보다 크다
컬럼 < ALL  →  컬럼 < MIN()  : 가장 작은 값보다 작다.
컬럼 > ANY  →  컬럼 > MIN() : 가장 작은 값보다 크다.
컬럼 < ANY  →  컬럼 < MAX() : 가장 큰 값보다 작다
```

---

## Multi Column Subquery

- 서브 쿼리 SELECT 문에서 여러 개의 컬럼을 검색한다.
- 비교 대상 컬럼과 서브 쿼리 컬럼은 반드시 1:1 대응되어야 한다.
- 서브 쿼리 결과가 하나의 행이라도 IN 연산자 사용을 권장한다

### 형식

```sql
  SELECT 컬럼 ...
  FROM 테이블
  WHERE (컬럼1, 컬럼2, ...) IN (SELECT 문장 : Sub query문);
```

### 실습

- 손하늘와 동일 관리자의 관리를 받으면서 업무도 같은 사원을 검색하는 예시
```sql
  SELECT eno 사번, ename 이름, mgr 관리자, job 업무
  FROM emp
  WHERE (mgr, job) IN (SELECT mgr, job               
                       FROM emp
                       WHERE ename = '손하늘')
  AND ename != '손하늘'; 
```

- 김선유와 부서 및 업무가 동일한 같은 사원을 검색하는 예시
```sql
  SELECT eno 사번, ename 이름, dno 부서번호, job 업무
  FROM emp                                    
  WHERE (dno, job) IN (SELECT dno, job              
                       FROM emp
                       WHERE ename = '김선유')
  AND ename != '김선유'; 
```
